---
title: "Report and Figures"
author: "Phil Chodrow"
date: "June 15, 2016"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: simplex
    code_folding: hide
---

```{r warning = FALSE, message = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(compx)
library(ggplot2)
library(rgdal)
library(ggmap)
library(dplyr)
library(gridExtra)
library(readr)
library(ggrepel)
library(DT)
library(caTools)
library(tidyr)
library(maptools)
library(grid)
library(stargazer)
library(magrittr)
library(rgeos)
library(extrafont)
loadfonts()

columns = c('Asian', 'Black', 'Other', 'White', 'Hispanic')

if(!dir.exists('figs')){
  dir.create('figs')
}

```

# Purpose 

The purpose of this document is to generate the figures used in this project. It is not a complete technical report; see the full writeup if that's what you're looking for. 

# Methods

## Motivation

The checkerboard problem is a foundational issue in the spatial analysis of diversity; it demonstrates the modifiable areal units problem (maup)

```{r, fig.height=3}

overlay <- data.frame(x = 6.5, y = 4.5)

expand.grid(x = 1:8, y = 1:8) %>%
	mutate(`(a)` = 1,
		   `(b)` = .5,
		   `(c)` = (x > 4)*1,
		   `(d)` = (x + y) %% 2) %>%
	gather(key = model, value = p, -x, -y) %>%
	ggplot(aes(x = x, y = y)) +
	ggthemes::theme_map() +
  geom_tile(aes(fill = p)) +
	scale_fill_continuous(low = 'white', high = 'black ', limits=c(0,1)) +
	facet_grid(~model, switch = 'x') +
	xlab('') +
	ylab('') +
	guides(fill=FALSE) + 
	theme(axis.ticks = element_blank(),
		  axis.text.x = element_blank(),
		  axis.text.y = element_blank(),
		  panel.margin = unit(1, "mm"),
		  panel.background = element_rect(),
		  panel.grid.major = element_line(size = 0),
		  panel.grid.minor = element_line(size = 0),
		  strip.background = element_rect(fill = "white", color = "white", size = 2),
		  plot.margin=unit(c(1,1,0,0),"mm"),
		  strip.text=element_text(vjust=-100)) + 
  geom_tile(aes(x = x, y = y), color = 'red', alpha = 0, size = 0.5, data = overlay)

# g <- checkerboard_illustration() 
# g
# g + theme(text=element_text(size=10, family="Palatino"))
ggsave('figs/checkerboard.pdf', width = 4, height = 1.3)
embed_fonts("figs/checkerboard.pdf", outfile="figs/checkerboard.pdf")
```

```{r, fig.height=3}

expand.grid(x = 1:8, y = 1:8) %>%
	mutate(`(a)` = .5,
		     `(b)` = (x > 4)*1,
		     `(c)` = ifelse(x == 7 & y %in% c(4,5), 0, `(b)`),
		     `(c)` = ifelse(x == 2 & y %in% c(4,5), 1, `(c)`),
		     `(d)` = (x + y) %% 2) %>%
	gather(key = model, value = p, -x, -y) %>%
	ggplot(aes(x = x, y = y)) +
	ggthemes::theme_map() +
  geom_tile(aes(fill = p)) +
	scale_fill_continuous(low = 'white', high = 'black ', limits=c(0,1)) +
	facet_grid(~model, switch = 'x') +
	xlab('') +
	ylab('') +
	guides(fill=FALSE) + 
	theme(axis.ticks = element_blank(),
		  axis.text.x = element_blank(),
		  axis.text.y = element_blank(),
		  panel.margin = unit(1, "mm"),
		  panel.background = element_rect(),
		  panel.grid.major = element_line(size = 0),
		  panel.grid.minor = element_line(size = 0),
		  strip.background = element_rect(fill = "white", color = "white", size = 2),
		  plot.margin=unit(c(1,1,0,0),"mm"),
		  strip.text=element_text(vjust=-100)) 

# g <- checkerboard_illustration() 
# g
# g + theme(text=element_text(size=10, family="Palatino"))
out_dir = 'figs/checkerboard_b.pdf'
ggsave(out_dir, width = 4, height = 1.3)
embed_fonts(out_dir, outfile=out_dir)
```



#  Mean Local Information

We'll read in some of the measures that we've computed:
```{r}

cache <- read_csv('throughput/info_cache.csv')

```

## Relationship to mutual information

```{r}
highlight <- cache %>%
	filter(I_XY > .45 | I_XY < .22)

cache %>%
	ggplot(aes(x = I_XY, y = J_XY)) + 
	geom_point(color = 'firebrick', alpha = 0.2) + 
	theme_light() + 
	ylab(expression(J(X,Y))) + 
	xlab(expression(I(X,Y))) + 
  geom_smooth(method = 'lm', se = FALSE, color = 'grey', linetype = 1, alpha = 0.2) + 
	# ggtitle('Mutual information and mean local information in major US cities') +
	geom_point(data = highlight, color = 'firebrick') + 
	geom_text_repel(data = highlight, aes(label = city)
	                # , family = 'Palatino' 
	                ) + 
  theme(
    # text=element_text(size=16, family="Palatino"),
        legend.title = element_text(size = 8),
        plot.title = element_text(size=10, vjust=1)) 

ggsave('figs/mutual_fisher.pdf', width = 7, height = 4)
embed_fonts("figs/mutual_fisher.pdf", outfile="figs/mutual_fisher.pdf")


```


## Relationship to population density

This is pretty interesting but we need to learn more
```{r}
lm_eqn <- function(df){
	m <- lm(J_XY ~ log(density) + I_XY, data = df) 
	eq <- substitute(italic(y) == a + b %.% 'I(X,Y)' + c %.% ~'log' ~italic(rho)*","~~italic(r)^2~"="~r2, 
					 list(a = format(coef(m)[1], digits = 2), 
					 	 b = format(coef(m)[2], digits = 2), 
					 	 c = format(coef(m)[3], digits = 2), 
					 	 r2 = format(summary(m)$adj.r.squared, digits = 3)))
	as.character(as.expression(eq))                 
}

cache %>% 
	rename(`I(X,Y)` = I_XY) %>% 
	# filter(!grepl('Los Angeles', city)) %>%
	ggplot(aes(x = density, y = J_XY)) +
	geom_smooth(method = 'lm', se = FALSE, color = 'black', size = .4) +
	annotate('text', x = 300, y = .12, label = lm_eqn(cache), parse = T) + 
	geom_point(color = 'grey') + 
	geom_point(color = 'firebrick', data = highlight) + 
	geom_text_repel(aes(label = city), size = 3, data = highlight) +
	scale_x_continuous(trans = 'log10') +
	# scale_y_continuous(trans = 'log10') +
	theme_light() +
  theme(text=element_text(size=16)) + 
	xlab(expression(rho~(population/km^{2}))) +
	ylab(expression(J(X,Y))) +
	annotation_logticks(size = .1, sides = 'b') 

ggsave('figs/density_fisher.pdf', width = 7, height = 4)
embed_fonts("figs/density_fisher.pdf", outfile="figs/density_fisher.pdf")

```


## Raw measures

```{r}
# Table --------
# 
# tab <- cache %>% 
# 	select(area, population, H_Y, I_XY, J = J_XY) %>% 
# 	mutate(Density = population / area) %>% 
# 	round(2) %>%
# 	cbind(cache$city, .) %>%
# 	rename(City = `cache$city`, 
# 		   `Area` = area,
# 		   Population = population,
# 		   HY = H_Y,
# 		   IXY = I_XY) %>%
# 	arrange(desc(Density)) %>% 
# 	select(City, `Area`, Population, Density, HY, IXY, J)
# 
# tab %>% write_csv('figs/table.csv')
# 
# tab %>% select(City, HY, IXY, J) %>% 
# 	filter(City %in% c( 'Albuquerque', 'Detroit', 'Philadelphia')) %>% 
# 	arrange(City) %>%
# 	mutate(HY = sprintf("%.2f", HY),
# 		   IXY = sprintf("%.2f", IXY),
# 		   J = sprintf("%.2f", J)) %>% 
# 	write_csv('figs/mini_table.csv')
# 
# 
# tab$Population <- format(tab$Population, big.mark=",", scientific=FALSE)
# tab$Area <- format(tab$Area, big.mark=",", scientific=FALSE)
# tab$Density <- format(tab$Density, big.mark=",", scientific=FALSE)
# 
# # datatable(tab, options = list(pageLength = 10), rownames = FALSE,
# 		  # caption = 'Table 1: This is a simple caption for the table.')

```

# Clusterings

```{r}

loss_curves <- read_csv('throughput/loss_curves.csv') %>%
	group_by(city) %>% 
	arrange(desc(I_XY)) %>% 
	mutate(I_XY = max(I_XY) - I_XY,
		   nclust = row_number())
	
info_summary <- read_csv('throughput/info_cache.csv')

join_cols <- c('area', 'population', 'density',  'H_Y', 'J_XY', 'city')
loss_curves <- loss_curves %>% left_join(info_summary[,join_cols])

```

## Example clustering

```{r}

cluster_map <- function(tracts_name, city, nclusters = 10){
	tracts <- readOGR(dsn = paste0('data/cities/',tracts_name), layer = 'geo', verbose = FALSE)
	tracts <- tracts[sum(tracts@data[,columns]) != 0,]
	clusters <- readRDS(paste0('throughput/clusterings/', city))
	
	tracts@data$cluster <- cutree(clusters,nclusters)
	overlay <- unionSpatialPolygons(tracts, IDs = tracts@data$cluster)
	
	tracts@data <- tracts@data %>%
		mutate(id = as.character(row_number() - 1))
	
	to_plot <- fortify(tracts)
	to_overlay <- fortify(overlay)
	
	to_plot <- to_plot %>% 
		left_join(tracts@data[,c('id', 'cluster')])
	
	to_plot %>% 
		ggplot() +
		geom_polygon(aes(x = long, y = lat, group = group, fill = factor(cluster))) + 
		scale_fill_brewer(palette = 'Set3', name = NULL, guide = 'none') + 
		# ggtitle(paste0('Example clustering for ', city)) + 
		ggthemes::theme_map() +
		theme(axis.ticks = element_blank(),
			  axis.text = element_blank(),
			  axis.title = element_blank(),
			  panel.grid = element_blank(),
			  legend.position = 'bottom') +
		geom_polygon(aes(x = long, y= lat, group = group), data = to_overlay, fill = NA, size = .3, color = 'black')

}

columns = c('Black', 'White', 'Asian', 'Hispanic', 'Other')

cluster_map('Detroit', 'Detroit', nclusters = 6)

ggsave('figs/example_cluster_map.pdf',  width = 7, height = 5)

```

```{r fig.cap='Example clusterings for 4 major cities.'}

make_cluster_groups <- function(city, nclusters = 10){
	tracts <- readOGR(dsn = paste0('data/cities/',city), layer = 'geo', verbose = FALSE)
	tracts <- tracts[sum(tracts@data[,columns]) != 0,]
	clusters <- readRDS(paste0('throughput/clusterings/', city))
	
	tracts@data$cluster <- cutree(clusters,nclusters)
	
	I <- mutual_info(tracts@data[,columns])
	
	tracts@data <- tracts@data %>%
		mutate(id = as.character(row_number() - 1))
	
	tracts@data[,c(columns, 'cluster')] %>% 
		group_by(cluster) %>% 
		summarise_each(funs(sum)) %>%
		gather(key = race, value = n, -cluster) %>% 
		mutate(n = n / sum(n)) %>% 
		group_by(cluster) %>% 
		filter(sum(n) > .01) %>% 
		ungroup() %>% 
		spread(key = race, value = n, fill = 0) %>% 
		# arrange(desc(White)) %>% 
		mutate(cluster = factor(LETTERS[1:nrow(.)])) %>%  
		gather(key = race, value = p, -cluster) %>% 
		mutate(city = city,
			   I = I,
			   title = paste0(city, ": I(C,Y) = ", round(I,2)))
		
}

nclusters = 5
df <- rbind(make_cluster_groups('Detroit', 3), 
	  make_cluster_groups('Boston', 5),
	  make_cluster_groups('Chicago', 4),
	  make_cluster_groups('Atlanta', 2)) 

df %>% 
	ggplot(aes(y = race, x = cluster, fill = p)) + 
	geom_tile(color = 'black') + 
	geom_text(aes(
		label = ifelse(p < 0.005, "", 100 * round(p,2)))) +
	theme_minimal() + 
	theme(axis.ticks.x = element_blank(),
		  axis.title = element_blank(),
		  legend.position="bottom",
		  legend.title = element_blank()) +
	scale_fill_continuous(low = 'white', high = 'steelblue', limits = c(0, NA), guide = FALSE) +
	ggtitle(paste0('Example clusters')) + 
	facet_wrap(~title, ncol = 2)

ggsave('figs/example_clusters.pdf', width = 10, height = 6)

```

```{r}
make_cluster_groups('Detroit', 6) %>% 
	mutate(race = factor(race, levels = c('Other', 'Asian', 'Hispanic', 'Black', 'White'))) %>% 
  group_by(cluster) %>% 
  mutate(alpha = p / sum(p),
         total = sum(p)) %>% 
	ggplot(aes(y = race, x = cluster, fill = cluster)) + 
  scale_fill_brewer(palette = 'Set3', name = NULL, guide = 'none', labels = LETTERS[1:nclusters]) + 
	geom_tile(color = 'black',  aes(alpha = alpha), size = 1) + 
	geom_text(aes(
		label = ifelse(p < 0.005, "", 100 * round(p,2))), size = 8) + 
  scale_alpha_continuous(guide = 'none', limits = c(0, .3)) + 
	theme_minimal() + 
	theme(
	  text=element_text(size=25),
		  axis.ticks.x = element_blank(),
		  axis.title = element_blank(),
		  legend.position="bottom",
		  legend.title = element_blank(),
		  line = element_blank()) 

ggsave('figs/example_clusters_detailed.pdf', width = 8, height = 6)
embed_fonts("figs/example_clusters_detailed.pdf", outfile="figs/example_clusters_detailed.pdf")


make_cluster_groups('Detroit', 6) %>% 
  spread(key = race, value = p, fill = 0) %>%
  select(Asian, Black, Hispanic, Other, White) %>% 
  as.matrix() %>% 
  mutual_info()

# 
# 
# tracts@data %>% group_by(cluster) %>% 
#   summarise(Asian = sum(Asian), 
#             Hispanic = sum(Hispanic), 
#             Other = sum(Other), 
#             White = sum(White), 
#             Black = sum(Black)) %>%
#   select(-cluster) %>% 
#   as.matrix() %>% mutual_info()

  


```

Follow up on Detroit by area (percent of area occupied by each cluster.)

```{r}
city = 'Detroit'
nclusters = 6

tracts <- readOGR(dsn = paste0('data/cities/',city), layer = 'geo', verbose = FALSE)
tracts <- tracts[sum(tracts@data[,columns]) != 0,]
clusters <- readRDS(paste0('throughput/clusterings/', city))

tracts@data$cluster <- cutree(clusters,nclusters)
overlay <- unionSpatialPolygons(tracts, IDs = tracts@data$cluster)

sapply(slot(overlay, "polygons"), slot, "area")  %>% simplex_normalize()


```

### AUC illustration

```{r}


binary_loss_curves <- read_csv('throughput/loss_curves_binary.csv') %>%
  group_by(city) %>% 
	arrange(desc(I_XY)) %>% 
	mutate(I_XY = max(I_XY) - I_XY,
		   nclust = row_number())

cities <- c('Atlanta','Philadelphia', 'Detroit', 'Chicago')

compute_AUC <- function(loss_curves, adjust_thresh = 0){
	loss_curves %>% 
		group_by(city) %>%
		mutate(exclude = (nclust != 1) & (cummax(I_XY - lag(I_XY,default = 0)) < adjust_thresh) & (nclust < 10)) %>% 
		filter(!exclude) %>%
		mutate(nclust = row_number()) %>% 
		mutate(dx = log(nclust / (nclust - 1))) %>%
		filter(nclust > 1) %>%
		group_by(city) %>%
		dplyr::arrange(nclust) %>%
		summarise(corner = max(I_XY) * log(max(nclust)),
				  area = trapz(nclust, I_XY / nclust)) %>%
		mutate(AUC = area / corner) %>%
		dplyr::arrange(desc(AUC)) 
}

summary <- compute_AUC(loss_curves, adjust_thresh = 0.005) 
summary <- summary %>% left_join(cache, by = c('city' = 'city')) %>%
	left_join(info_summary[,c('city', 'J_XY', 'I_XY')]) %>%
	filter(I_XY > 0)

sub_summary <- summary %>% filter(city %in% cities)

sub_curves <- binary_loss_curves %>%
	filter(city %in% cities) 

end_points <- sub_curves %>%
	group_by(city) %>%
	filter(nclust == max(nclust))

rects <- sub_curves %>% group_by(city) %>% 
	summarise(xmin = 1, ymin = 0, xmax = max(nclust), ymax = max(I_XY))

filled <- sub_curves[,c('nclust','I_XY', 'city')] %>% 
  select(city, I_XY, nclust) %>% 
  ungroup()

corner <- filled %>% group_by(city) %>%
	summarise(I_XY = 0,
	          nclust = max(nclust)) 

filled <- rbind(corner, filled) %>%  # problem is right here, the columns don't add up
	dplyr::arrange(city, nclust, desc(I_XY))

sub_curves %>% 
	ggplot() +
	geom_path(aes(x = nclust, y = I_XY, group = city, color = city)) +
	scale_x_continuous(trans = 'log10', limit = c(1, NA), expand = c(0, 0)) +
	scale_y_continuous(limit = c(0,max(sub_curves$I_XY + 0.02)), expand = c(0, 0)) +
	theme_light() +
  theme(text=element_text(size=16),
        panel.margin = unit(2, "lines"),
        panel.border = element_blank(),
        strip.background = element_rect(fill = "white", color = "white", size = 2),
        strip.text.x = element_text(size = 16, color = 'black')) + 
	annotation_logticks(size = .1, sides = 'b', scaled = T) + 
	geom_rect(data = rects, aes(xmin = xmin,
								ymin = ymin,
								xmax = xmax,
								ymax = ymax,
								group = city,
								color = city),
			  # color = 'grey',
			  alpha = 0,
			  size = 0.25) +
	# geom_text(aes(x = nclust, y = I_XY, label = city, hjust = -.2), data = end_points) + 
	geom_polygon(aes(nclust, I_XY, fill = city), data = filled, alpha = .2) + 
	geom_text(aes(x = 50, y = .15, label = paste('AUC = ', round(AUC,2))), data = sub_summary, size = 6) + 
	# geom_text(aes(x = 50, y = .1, label = paste('J(X,Y) = ', round(J_XY,2))), data = sub_summary) +
	facet_wrap(~city, ncol = 2) + 
  scale_fill_brewer(palette = 'Set1', name = NULL, guide = 'none') +
  scale_color_brewer(palette = 'Set1', name = NULL, guide = 'none') + 
	# scale_color_discrete(guide = F) + 
	xlab('Number of clusters (n)') + 
	ylab(expression(I(C[n],Y))) 

ggsave('figs/AUC_illustration.pdf', width = 7, height = 5.5)
embed_fonts('figs/AUC_illustration.pdf', outfile = 'figs/AUC_illustration.pdf')
```

```{r}

adjust_thresh = 0.01
highlights  <- c('Philadelphia', 'Atlanta', 'Detroit', 'Chicago')
curves <- binary_loss_curves %>% 
  mutate(exclude = (nclust != 1) & (cummax(I_XY - lag(I_XY,default = 0)) < adjust_thresh) & (nclust < 10)) %>% 
	filter(!exclude,
	       max(I_XY > 0.0)) %>%
	mutate(nclust = row_number())
  
highlighted <- curves %>% 
  filter(city %in% highlights)

background <-  curves %>% 
  filter(!(city %in% highlighted))

end_points <- highlighted %>%
	group_by(city) %>%
	filter(nclust == 10,
	       city %in% highlights)

end_points <- data.frame(city = c('Atlanta', 'Philadelphia', 'Detroit', 'Chicago'),
                         nclust = c(50, 7, 8, 1000),
                         I_XY = c(.35, .175, .38, .42))

rects <- highlighted %>% group_by(city) %>% 
	summarise(xmin = 1, ymin = 0, xmax = max(nclust), ymax = max(I_XY))


# grey background

background %>% 
  ggplot() +
  geom_path(aes(group = city, x = nclust, y = I_XY), color = 'grey', alpha = 0.6) + 
  geom_path(aes(group = city, color = city, x = nclust, y = I_XY), data = highlighted) +
  geom_label(aes(x = nclust, y = I_XY, label = city, fill = city), data = end_points) +
  theme_light() +
  scale_x_continuous(trans = 'log10', limits = c(1,NA), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,.5), expand = c(0, 0)) + 
  scale_color_brewer(palette = 'Set1', name = NULL, guide = 'none') +
  scale_fill_brewer(palette = 'Set1', name = NULL, guide = 'none') +
  xlab('Number of clusters (n)') + 
	ylab(expression(I(C[n],Y))) +
  # geom_vline(xintercept=2, alpha = .2) + 
  annotation_logticks(sides = 'b', size = .2) +
  geom_rect(data = rects, aes(xmin = xmin,
								ymin = ymin,
								xmax = xmax,
								ymax = ymax,
								group = city,
								color = city),
			  # color = 'grey',
			  alpha = 0,
			  size = 0.25)
  
  ggsave('figs/binary_loss_curves.pdf', width = 7, height = 4)
  embed_fonts("figs/binary_loss_curves.pdf", outfile="figs/binary_loss_curves.pdf")

```


```{r}

adjust_thresh = 0.01
highlights  <- c('Philadelphia', 'Atlanta', 'Detroit', 'Chicago')
curves <- loss_curves %>% 
  mutate(exclude = (nclust != 1) & (cummax(I_XY - lag(I_XY,default = 0)) < adjust_thresh) & (nclust < 10)) %>% 
	filter(!exclude,
	       max(I_XY > 0.0)) %>%
	mutate(nclust = row_number())
  
highlighted <- curves %>% 
  filter(city %in% highlights)

background <-  curves %>% 
  filter(!(city %in% highlighted))

end_points <- highlighted %>%
	group_by(city) %>%
	filter(nclust == 10,
	       city %in% highlights)

end_points <- data.frame(city = c('Atlanta', 'Philadelphia', 'Detroit', 'Chicago'),
                         nclust = c(50, 7, 8, 1000),
                         I_XY = c(.36, .19, .46, 0.66))

rects <- highlighted %>% group_by(city) %>% 
	summarise(xmin = 1, ymin = 0, xmax = max(nclust), ymax = max(I_XY))

# grey background

filled <- highlighted[,c('nclust','I_XY', 'city')] %>% 
  select(city, I_XY, nclust) %>% 
  ungroup()

corner <- filled %>% group_by(city) %>%
	summarise(I_XY = 0,
	          nclust = max(nclust)) 

filled <- rbind(corner, filled) %>%  # problem is right here, the columns don't add up
	dplyr::arrange(city, nclust, desc(I_XY))




background %>% 
  ggplot() +
  geom_path(aes(group = city, x = nclust, y = I_XY), color = 'grey', alpha = 0.6) + 
  geom_path(aes(group = city, color = city, x = nclust, y = I_XY), data = highlighted, size = 1) +
  theme_light() +
  scale_x_continuous(trans = 'log10', limits = c(1,NA), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0,.7), expand = c(0, 0)) + 
  scale_color_brewer(palette = 'Set1', name = NULL, guide = 'none') +
  scale_fill_brewer(palette = 'Set1', name = NULL, guide = 'none') +
  xlab('Number of clusters (n)') + 
	ylab(expression(I(C[n],Y))) +
  # geom_vline(xintercept=2, alpha = .2) + 
  annotation_logticks(sides = 'b', size = .2) +
  # geom_polygon(aes(nclust, I_XY, fill = city, group = city), data = filled, alpha = .15) + 
  geom_rect(data = rects, aes(xmin = xmin,
								ymin = ymin,
								xmax = xmax,
								ymax = ymax,
								group = city,
								color = city),
			  # color = 'grey',
			  alpha = 0,
			  size = 0.3) + 
  geom_label(aes(x = nclust, y = I_XY, label = city, fill = city), data = end_points) 

  
  ggsave('figs/loss_curves.pdf', width = 7, height = 4)
  embed_fonts("figs/loss_curves.pdf", outfile="figs/loss_curves.pdf")

```





```{r}

# dippy point that doesn't seem to be true here: if you don't have any excluded points on your curve, your AUC should be the same. 

adjusted_summary <- compute_AUC(loss_curves, adjust_thresh = .005) %>%
	select(city, adj_AUC = AUC)

summary <- summary %>% 
	left_join(adjusted_summary)
```

```{r}

summary %>% 
	ggplot() +
	aes(x = AUC, y = adj_AUC) +
	geom_point() + 
	geom_text_repel(aes(label = city)) + 
	geom_abline(slope = 1, intercept = 0)

```


## Raw clustering performance 

```{r}

summary[,c('I_XY', 'J_XY', 'AUC', 'adj_AUC')] %>% 
	round(2) %>% 
	cbind(summary$city) %>% 
	select(city = `summary$city`, I_XY, J_XY, AUC, adj_AUC) %>%
	datatable(options = list(pageLength = 10), rownames = FALSE,
		  caption = 'Table 1: This is a simple caption for the table.')
```

# Relationship to information measures 

```{r}

highlight <- summary %>% 
	filter(I_XY >= 0)

summary %>%
	ggplot() +
	aes(x = I_XY, y = AUC) +
	geom_point(aes(color = J_XY)) +
	geom_smooth(color = 'grey', se = F) +
	geom_text_repel(aes(label = city), data = highlight) + 
	theme_minimal() + 
	ggtitle('Clustering performance and mutual information') +
	scale_color_continuous(low = 'white', high = 'firebrick',limits = c(0,2)) +
	xlab('I(X,Y)') + 
	ylab('AUC')

ggsave('figs/info_performance.pdf', width = 10, height = 6)

```

```{r}
highlight <- summary %>% filter(I_XY > .4)

summary %>%
	ggplot() +
	aes(x = I_XY, y = adj_AUC) +
	geom_point(aes(color = J_XY)) +
	geom_smooth(color = 'grey', se = F) +
	geom_text_repel(aes(label = city), data = highlight) + 
	theme_minimal() + 
	ggtitle('Clustering performance and mutual information') +
	xlab('I(X,Y)') + 
	ylab('AUC (geographically adjusted)') + 
	scale_color_continuous(low = 'white', high = 'firebrick',limits = c(0,.2), name = "J(X,Y)", guide = guide_colorbar(direction = 'horizontal')) +
	theme(legend.justification=c(1.5,0),
			  legend.position=c(1,0))

ggsave('figs/info_performance_adjed.pdf', width = 10, height = 6)

```

### Basic linear regression 

```{r}
summary <- compute_AUC(loss_curves, adjust_thresh = 0.005) 
summary <- summary %>% left_join(cache, by = c('city' = 'city')) %>%
	left_join(info_summary[,c('city', 'J_XY', 'I_XY')]) %>%
	filter(I_XY > 0)

summary %>% mutate(AUC = AUC / max(AUC),
		   `I(X,Y)` = I_XY / max(I_XY),
		   `J(X,Y)` = J_XY / max(J_XY),
		   `H(Y)` = H_Y / max(H_Y)) %>%
	filter(I_XY > 0) %>%
	lm(AUC ~ `H(Y)` + `I(X,Y)` + `J(X,Y)`, data = .) %>% 
	stargazer(flip = T, 
			  # table.layout = '#tn', 
			  style = 'all2',
			  ci = T,covariate.labels = c('$H(Y)$', '$I(X,Y)$','$J(X,Y)$', 'Intercept'),
			  # table.layout = '-=-!=!dtas',
			  float = F) %>% 
	write(file = 'figs/adjusted_regression.txt')
```

# Core maps

In this code chunk, we construct maps of binary (black/nonblack) segregation in Atlanta and Philadelphia, and then demonstrate the grid-based approach to computing the local information $J(X,Y)$. 

```{r}

cities <- c('Philadelphia', 'Atlanta', 'Chicago', 'Detroit')

tab <- data.frame(city = character(), H_Y = numeric(), I_XY = numeric(), J_XY = numeric())

for(city in cities){
  tracts <- readOGR(dsn = paste0('data/cities/',city), 
  	                         layer = 'geo', 
  	                         verbose = FALSE)
  
  grid_tract <- read_csv(file = paste0('throughput/grid_tracts/', city, '.csv'))
  grid <- readOGR(dsn = paste0('throughput/grids/',city), 
  	                         layer = 'grid', 
  	                         verbose = FALSE)
  
  df <- tracts@data %>%
    mutate(percent_black = Black / total) %>% 
    tbl_df
  
  if(city == 'Atlanta'){
    guide = 'none'
  }else{
    guide = guide_colorbar(barwidth = 1, barheight = 4, label.theme = element_text(size = 7, angle = 0))
  }
  
  this_city <- city
  J_XY <- summary %>% filter(city == this_city) %>% 
    select(J_XY) %>% 
    as.numeric() %>% 
    round(2)
  
  tracts %>% 
    fortify(region = 'GEOID') %>% 
    tbl_df() %>% 
    left_join(df, by = c('id' = 'GEOID')) %>% 
    ggplot(aes(x = long, y = lat, fill = percent_black, group = group)) + 
    geom_polygon() + 
    viridis::scale_fill_viridis(name = 'Percent Black', 
                                labels = scales::percent, 
                                option = 'magma', 
                                limits = c(0,1),
                                guide = guide) + 
    ggtitle(paste0(city)) + 
    ggthemes::theme_map() + 
    theme(legend.justification=c(0,0), legend.position=c(.65,0)) + 
    theme(text=element_text(size=16),
          plot.title = element_text(size=10, 
                                  vjust=1),
          legend.title = element_text(size = 8))
  
  ggsave(paste0('figs/', city, '_percent_black.pdf'), width = 7, height = 7, units = 'cm')
  embed_fonts(paste0('figs/', city, '_percent_black.pdf'), outfile = paste0('figs/', city, '_percent_black.pdf'))
  
  tracts@data <- tracts@data %>% 
    mutate(non_black = Hispanic + Other + White + Asian)
  
  columns = races
  stuff <- compx::info_analysis(tracts, columns = columns, resolution = NULL, grid_tract = grid_tract, grid = grid)
  
  stuff$grid %>% 
    fortify(region = 'id') %>% 
    left_join(stuff$grid@data[,c('id', 'pop', 'info')], by = c('id' = 'id')) %>% 
    ggplot(aes(x = long, y = lat, fill =  info, group = group)) + 
    geom_polygon() + 
    viridis::scale_fill_viridis(name = expression(J[Y](B)), 
                                limits = c(0, .5), 
                                option = 'magma',
                                guide = guide) + 
    ggthemes::theme_map() +
    ggtitle(city) + 
    theme(text=element_text(size=16),
          legend.justification=c(0,0), legend.position=c(.65,0),
          legend.title = element_text(size = 8),
          plot.title = element_text(size=10, vjust=1)) 
  
  # paste0('figs/', city, '_grid.pdf')
  ggsave(paste0('figs/', city, '_grid.pdf'), width = 7, height = 7, units = 'cm')
  embed_fonts(paste0('figs/', city, '_grid.pdf'), outfile = paste0('figs/', city, '_grid.pdf'))
  
  percent_black = sum(tracts@data$Black) / sum(tracts@data$total)
  
  new_row <- data.frame(city = city, H_Y = stuff$H_Y, I_XY = stuff$I_XY, J_XY = stuff$J_XY)
  tab <- rbind(tab, new_row)
}

tab[,-1] <- round(tab[,-1],2)

tab %>% 
  mutate(percent_black = percent_black * 100) %>%   
  write_csv('figs/comparative_summary.csv')

```


# Binary cluster maps

In this code chunk we produce maps based on the clusterings we found for Philadelphia and Atlanta. 

```{r}


cluster_map_percent_black <- function(tracts_name, city, nclusters = 10){
	tracts <- readOGR(dsn = paste0('data/cities/',tracts_name), layer = 'geo', verbose = FALSE)
	
	
	
	tracts <- tracts[sum(tracts@data[,columns]) != 0,]
	clusters <- readRDS(paste0('throughput/clusterings/', city))
	
	tracts@data$cluster <- cutree(clusters,nclusters)
	tracts@data <- tracts@data %>%
	  mutate(non_Black = White + Asian + Hispanic + Other) 
	totals = tracts@data %>% 
	  group_by(cluster) %>%
	  summarise(non_Black = sum(non_Black),
	            Black = sum(Black)) %>%
	  mutate(percent_black = Black / (Black + non_Black))
	
	info <- totals %>% select(non_Black, Black) %>% as.matrix() %>% mutual_info() %>% round(2)
	total_info <- tracts@data %>% select(non_Black, Black) %>% as.matrix() %>% mutual_info() %>% round(2)
	
	overlay <- unionSpatialPolygons(tracts, IDs = tracts@data$cluster)
	
	tracts@data <- tracts@data %>% 
	  left_join(totals, by = c('cluster' = 'cluster')) %>% 
		mutate(id = as.character(row_number() - 1))
	
	to_plot <- fortify(tracts)
	to_overlay <- fortify(overlay)
	
	to_plot <- to_plot %>% 
		left_join(tracts@data[,c('id', 'cluster', 'percent_black')])
	
	
	title <- paste0(tracts_name, ': ', nclusters, ' clusters')
	
	
  if(tracts_name == 'Atlanta'){
    guide = 'none'
  }else{
    guide = guide_colorbar(barwidth = 1, barheight = 4, label.theme = element_text(size = 7, angle = 0))
  }
	
	g <- to_plot %>% 
		ggplot() +
		geom_polygon(aes(x = long, y = lat, group = group, fill = percent_black)) + 
		# ggtitle(paste0('Example clustering for ', city)) + 
		ggthemes::theme_map() + 
	  viridis::scale_fill_viridis(option = 'magma', 
	                              name = 'Percent Black', 
	                              labels = scales::percent, 
	                              limits = c(0,1),
	                              guide = guide) + 
	  ggtitle(title) + 
		geom_polygon(aes(x = long, y= lat, group = group), data = to_overlay, fill = NA, size = .3, color = 'black') + 
	  theme(text=element_text(size=16),
	        legend.justification=c(0,0), legend.position=c(.65,0),
          legend.title = element_text(size = 8),
          plot.title = element_text(size=10, vjust=1))
	
	return(list(g = g, info = info, total_info = total_info))
}

```


```{r}

tab <- data.frame(city = character(), total_info = numeric(), info_4 = numeric(), info_20 = numeric())
for(city in c('Philadelphia', 'Atlanta')){
  if(!file.exists(paste0('throughput/clusterings/', city, '_binary'))){
    print(city)
  	spdf <- readOGR(dsn = paste0('data/cities/', city), layer = 'geo',verbose = FALSE)
#   if(city == 'Philadelphia'){
#   	   exclude <- c('421010098023','421010098022', '421010098021', '421010098011',  '421010098012')
#     spdf <- spdf[!(spdf@data$GEOID %in% exclude),]   
# 
# 	}
  	spdf <- spdf[sum(spdf@data[,columns]) != 0,]
  	df <- spdf@data[,columns]
  	df <- df %>% 
  	  mutate(non_Black = Asian + Hispanic + White + Other) %>% 
  	  select(Black, non_Black)
  	row.names(df) <- 1:nrow(df)
  	constraint <- gRelate(spdf, byid = TRUE, pattern = '****1****')
  	a <- info_clust(df, constraint)
  	saveRDS(a, file = paste0('throughput/clusterings/',city, '_binary'))
  }
	columns = c('Black', 'White', 'Asian', 'Hispanic', 'Other')
  new_row <- data.frame(city = city, total_info = 0, info_4 = 0, info_20 = 0)
	for(nclusters in c(4, 20)){
  	c <- cluster_map_percent_black(city, paste0(city, '_binary'), nclusters = nclusters)
  	new_row$total_info = c$total_info
  	new_row[,paste0('info_', nclusters)] <- c$info
  	c$g
  	ggsave(paste0('figs/', city, '_clusters_binary_', nclusters, '.pdf'), width = 7, height = 7, units = 'cm')
  	embed_fonts(paste0('figs/', city, '_clusters_binary_', nclusters, '.pdf'),
  	            outfile = paste0('figs/', city, '_clusters_binary_', nclusters, '.pdf'))
	}
  tab <- rbind(tab, new_row)
}
  
tab %>% 
  write_csv('figs/clustering_summary.csv')


```

```{r}

atlanta <- readOGR(dsn = paste0('data/cities/', 'Atlanta'), 
  	                         layer = 'geo', 
  	                         verbose = FALSE)

pop <- atlanta@data %>% 
  select(Asian, Black, Hispanic, Other, White) %>% 
  summarise_each(funs(sum)) %>% 
  as.numeric()

pop / sum(pop)

```

# batch figs

```{r}

if(!dir.exists('figs/batch_figs')){
  dir.create('figs/batch_figs')
}

guide = guide_colorbar(barwidth = 1, barheight = 4, label.theme = element_text(size = 7, angle = 0))
cities <- cache$city

tab <- data.frame(city = character(), percent_black = numeric(), H_Y = numeric(), I_XY = numeric(), J_XY = numeric())

for(city in cities){
  tracts <- readOGR(dsn = paste0('data/cities/',city), 
  	                         layer = 'geo', 
  	                         verbose = FALSE)
  
  grid_tract <- read_csv(file = paste0('throughput/grid_tracts/', city, '.csv'))
  grid <- readOGR(dsn = paste0('throughput/grids/',city), 
  	                         layer = 'grid', 
  	                         verbose = FALSE)
  
  df <- tracts@data %>%
    mutate(percent_black = Black / total) %>% 
    tbl_df
  
  this_city <- city
  J_XY <- summary %>% filter(city == this_city) %>% 
    select(J_XY) %>% 
    as.numeric() %>% 
    round(2)
  
  tracts %>% 
    fortify(region = 'GEOID') %>% 
    tbl_df() %>% 
    left_join(df, by = c('id' = 'GEOID')) %>% 
    ggplot(aes(x = long, y = lat, fill = percent_black, group = group)) + 
    geom_polygon() + 
    viridis::scale_fill_viridis(name = 'Percent Black', 
                                labels = scales::percent, 
                                option = 'magma', 
                                limits = c(0,1),
                                guide = guide) + 
    ggtitle(paste0(city)) + 
    ggthemes::theme_map() + 
    theme(legend.justification=c(0,0), legend.position=c(.65,0)) + 
    theme(text=element_text(size=16),
          plot.title = element_text(size=10, 
                                  vjust=1),
          legend.title = element_text(size = 8))
  
  ggsave(paste0('figs/batch_figs/', city, '_percent_black.pdf'), width = 7, height = 7, units = 'cm')
  embed_fonts(paste0('figs/batch_figs/', city, '_percent_black.pdf'), outfile = paste0('figs/batch_figs/', city, '_percent_black.pdf'))
  
  tracts@data <- tracts@data %>% 
    mutate(non_black = Hispanic + Other + White + Asian)
  
  columns = c('non_black', 'Black')
  stuff <- compx::info_analysis(tracts, columns = columns, resolution = NULL, grid_tract = grid_tract, grid = grid)
  
  stuff$grid %>% 
    fortify(region = 'id') %>% 
    left_join(stuff$grid@data[,c('id', 'pop', 'info')], by = c('id' = 'id')) %>% 
    ggplot(aes(x = long, y = lat, fill =  info, group = group)) + 
    geom_polygon() + 
    viridis::scale_fill_viridis(name = expression(J[Y](B)), 
                                limits = c(0, .5), 
                                option = 'magma',
                                guide = guide) + 
    ggthemes::theme_map() +
    ggtitle(city) + 
    theme(text=element_text(size=16),
          legend.justification=c(0,0), legend.position=c(.65,0),
          legend.title = element_text(size = 8),
          plot.title = element_text(size=10, vjust=1)) 
  
  # paste0('figs/', city, '_grid.pdf')
  ggsave(paste0('figs/batch_figs/', city, '_grid.pdf'), width = 7, height = 7, units = 'cm')
  embed_fonts(paste0('figs/batch_figs/', city, '_grid.pdf'), outfile = paste0('figs/batch_figs/', city, '_grid.pdf'))
  
  percent_black = sum(tracts@data$Black) / sum(tracts@data$total)
  
  new_row <- data.frame(city = city, percent_black = percent_black, H_Y = stuff$H_Y, I_XY = stuff$I_XY, J_XY = stuff$J_XY)
  tab <- rbind(tab, new_row)
}

tab[,-1] <- round(tab[,-1],2)

tab %>% 
  mutate(percent_black = percent_black * 100) %>%   
  write_csv('figs/batch_figs/comparative_summary.csv')

```



```{r}

tab <- data.frame(city = character(), total_info = numeric(), info_6 = numeric(), info_20 = numeric())
for(city in cities){
  if(!file.exists(paste0('throughput/clusterings/', city, '_binary'))){
    print(city)
  	spdf <- readOGR(dsn = paste0('data/cities/', city), layer = 'geo',verbose = FALSE)
  	spdf <- spdf[sum(spdf@data[,columns]) != 0,]
  	df <- spdf@data[,columns]
  	df <- df %>% 
  	  mutate(non_Black = Asian + Hispanic + White + Other) %>% 
  	  select(Black, non_Black)
  	row.names(df) <- 1:nrow(df)
  	constraint <- gRelate(spdf, byid = TRUE, pattern = '****1****')
  	a <- info_clust(df, constraint)
  	saveRDS(a, file = paste0('throughput/clusterings/',city, '_binary'))
  }
	columns = c('Black', 'White', 'Asian', 'Hispanic', 'Other')
  new_row <- data.frame(city = city, total_info = 0, info_6 = 0, info_20 = 0)
	for(nclusters in c(6, 20)){
  	c <- cluster_map_percent_black(city, paste0(city, '_binary'), nclusters = nclusters)
  	new_row$total_info = c$total_info
  	new_row[,paste0('info_', nclusters)] <- c$info
  	c$g
  	ggsave(paste0('figs/batch_figs/', city, '_clusters_binary_', nclusters, '.pdf'), width = 7, height = 7, units = 'cm')
  	embed_fonts(paste0('figs/batch_figs/', city, '_clusters_binary_', nclusters, '.pdf'),
  	            outfile = paste0('figs/batch_figs/', city, '_clusters_binary_', nclusters, '.pdf'))
	}
  tab <- rbind(tab, new_row)
}
  
tab %>% 
  write_csv('figs/batch_figs/clustering_summary.csv')

```

```{r}

races <- c('Asian', 'Black', 'Hispanic', 'Other', 'White')

prominence_map <- function(city, races){
  tracts <- readOGR(dsn = paste0('data/cities/',city), layer = 'geo', verbose = FALSE)
  
  overall_dist <- tracts@data %>% 
  	select_(.dots = races) %>% 
  	colSums() %>% 
  	simplex_normalize()	
  
  f <- function(row){
  here <- tracts@data[row,races] %>% 
  	simplex_normalize
  index <- which.max(here * log(here / overall_dist))
  return(races[index])
  }
  
  g <- function(row){
  	here <- tracts@data[row,races] %>% 
  		simplex_normalize
  	return(max(here * log(here / overall_dist), na.rm = T))
  }
  
  tracts@data$prominent_race <- 1:nrow(tracts@data) %>% 
  as.matrix() %>% 
  apply(FUN = f, MARGIN = 1)
  
  tracts@data$prominence <- 1:nrow(tracts@data) %>% 
  	as.matrix() %>% 
  	apply(FUN = g, MARGIN = 1)
  
  df <- tracts@data
  
  g <- tracts %>% fortify(region = 'GEOID') %>% 
      tbl_df() %>% 
      left_join(df, by = c('id' = 'GEOID')) %>% 
      ggplot() + 
      geom_polygon(aes(x = long, y = lat, fill = prominent_race, group = group, alpha = prominence))  +
      ggthemes::theme_map() + 
      scale_alpha_continuous(guide = 'none', limits = c(0,1)) + 
      ggtitle(city) + 
      theme(plot.title = element_text(size=20, vjust = -5),
            legend.title = element_blank(),
            legend.position = c(.7, .1))
  g
}

cluster_map <- function(map, city_name, races, nclusters){

  tracts <- readOGR(dsn = paste0('data/cities/',city_name), layer = 'geo', verbose = FALSE)
  tracts <- tracts[sum(tracts@data[,races]) != 0,]
  clusters <- readRDS(paste0('throughput/clusterings/', city_name))
  loss_curves <- readr::read_csv('throughput/loss_curves.csv') %>%
  	group_by_('city') %>% 
  	arrange(desc(I_XY)) %>% 
  	mutate(I_XY = max(I_XY) - I_XY,
  		   nclust = row_number(),
  		   I_diff = I_XY - lag(I_XY))
    for(ncluster in nclusters){
  		
  		weight <- loss_curves %>% filter(city == city_name, 
  					   nclust == ncluster) %>% 
  		ungroup() %>% 
  		select(I_diff) %>% 
  		as.numeric()
  		
  		tracts@data$cluster <- cutree(clusters,ncluster)
  		overlay <- unionSpatialPolygons(tracts, IDs = tracts@data$cluster) %>% fortify()
  		
  		g <- g + geom_polygon(aes(x = long, y = lat, group = group),data = overlay,
  		                      alpha = 0, fill = NA, size = 8*weight, color = 'black') 
    }
  
  max_weight <- loss_curves %>% filter(city == city_name) %>% 
  		ungroup() %>% 
  		summarise(max_diff = max(I_diff, na.rm = T)) %>% 
  		as.numeric()
  
  
  tracts@data$cluster <- 1
  overlay <- unionSpatialPolygons(tracts, IDs = tracts@data$cluster) %>% fortify()
  g <- g + geom_polygon(aes(x = long, y = lat, group = group),data = overlay,
  		                      alpha = 0, fill = NA, size = 8*max_weight, color = 'white')
  
  
  g
}


```

```{r}

for(city in info_summary$city){
  print(city)
  
  g <- prominence_map(city, races)
  g <- g + scale_fill_brewer(palette = 'Set1')
  
  out_dir <- paste0('figs/batch_figs/prominence_map_', city, '.pdf')
  
  ggsave(out_dir, width = 14, height = 14, units = 'cm')
  embed_fonts(out_dir, outfile=out_dir)
  
  nclusters <- 1:6
  g <- g %>% cluster_map(city, races, nclusters)  
  
  out_dir <- paste0('figs/batch_figs/cluster_map_', city, '.pdf')
  ggsave(out_dir, width = 14, height = 14, units = 'cm')
  embed_fonts(out_dir, outfile=out_dir)
}

```


```{r}
city <- 'Detroit'
print(city)
nclusters <- 1:6
g <- prominence_map(city, races)

guide <- guide_legend(label.theme = element_text(size = 14, angle = 0))

g <- g + scale_fill_brewer(palette = 'Set1', guide = guide)

g <- g %>% cluster_map(city, races, nclusters)  

out_dir <- paste0('figs/prominence_map_Detroit.pdf')
ggsave(out_dir, width = 14, height = 14, units = 'cm')
embed_fonts(out_dir, outfile=out_dir)

labels <- data_frame(label = c('A', 'B', 'C', 'D', 'E', 'F'),
                     long   = c(-83.35, -83.1558, -83.164, -82.905, -83.055, -83.1258),
                     lat  = c(42.37, 42.39, 42.28, 42.4, 42.4, 42.3214)) 

g +
  geom_point(aes(x = long, y = lat), data = labels, size = 9, pch=21, color = 'black', fill = 'white', alpha = .6) + 
  geom_text(aes(x = long, y = lat, label = label), 
                  data = labels, 
                  size = 7, fontface = 'bold')

out_dir <- paste0('figs/cluster_map_Detroit_labeled.pdf')

ggsave(out_dir, width = 14, height = 10, units = 'cm')
embed_fonts(out_dir, outfile=out_dir)

```
```{r}

g <- g + scale_fill_brewer(palette = 'Set1', guide = guide)
g + theme(legend.position = c(.8, .1))

```



```{r}
for(city in c('Chicago', 'Atlanta', 'Detroit', 'Philadelphia')){
  print(city)
  
  g <- prominence_map(city, races)
  
  if(city %in% c('Detroit', 'Philadelphia')){
    guide <- guide_legend(label.theme = element_text(size = 14, angle = 0))
    
  }else{
    guide = FALSE
  }
  
  g <- g + scale_fill_brewer(palette = 'Set1', guide = guide)
  
  out_dir <- paste0('figs/prominence_map_', city, '.pdf')
  
  ggsave(out_dir, width = 14, height = 10, units = 'cm')
  embed_fonts(out_dir, outfile=out_dir)
  
  nclusters <- 1:6
  g <- g %>% cluster_map(city, races, nclusters)  
  
  out_dir <- paste0('figs/cluster_map_', city, '.pdf')
  ggsave(out_dir, width = 14, height = 10, units = 'cm')
  embed_fonts(out_dir, outfile=out_dir)
}
```


```{r}
pal <- RColorBrewer::brewer.pal(name = 'Set1', 5)

make_cluster_groups('Detroit', 6) %>% 
	mutate(race = factor(race, levels = c('Asian', 'Other', 'Hispanic', 'Black', 'White'))) %>% 
  group_by(cluster) %>% 
  mutate(alpha = p / sum(p),
         total = sum(p)) %>% 
	ggplot(aes(y = race, x = cluster, fill = race)) + 
  scale_fill_manual(values = c(pal[1], pal[4], pal[3], pal[2], pal[5]), name = NULL, guide = 'none', labels = LETTERS[1:nclusters]) + 
	geom_tile(color = 'black',  aes(alpha = alpha), size = 1) + 
	geom_text(aes(
		label = ifelse(p < 0.005, "", 100 * round(p,2))), size = 8) + 
  scale_alpha_continuous(guide = 'none', limits = c(0, 1)) + 
	theme_minimal() + 
	theme(
	  text=element_text(size=25),
		  axis.ticks.x = element_blank(),
		  axis.title = element_blank(),
		  legend.position="bottom",
		  legend.title = element_blank(),
		  line = element_blank()) 

ggsave('figs/example_clusters_detailed.pdf', width = 8, height = 6)
embed_fonts("figs/example_clusters_detailed.pdf", outfile="figs/example_clusters_detailed.pdf")


```


# Session info
```{r}
sessionInfo()
```
